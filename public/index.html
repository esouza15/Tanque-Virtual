<!doctype html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Tanque Digital</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#111827" />
        <meta name="mobile-web-app-capable" content="yes" />
        <link
            rel="icon"
            type="image/png"
            href="https://img.icons8.com/3d-fluency/94/gas-station.png"
        />
        <link
            rel="apple-touch-icon"
            href="https://img.icons8.com/3d-fluency/188/gas-station.png"
        />

        <style>
            .fuel-gradient {
                background: linear-gradient(
                    90deg,
                    #ef4444 0%,
                    #facc15 25%,
                    #22c55e 100%
                );
            }
            input::-webkit-outer-spin-button,
            input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
        </style>
    </head>
    <body
        class="bg-gray-900 text-white font-sans min-h-screen flex flex-col items-center p-4"
    >
        <header class="w-full max-w-md py-4 text-center">
            <h1
                class="text-xl font-bold text-gray-500 uppercase tracking-widest"
            >
                Meu Tanque Digital
            </h1>
        </header>

        <main
            class="w-full max-w-md bg-gray-800 rounded-[2.5rem] shadow-2xl p-6 border border-gray-700"
        >
            <div class="text-center mb-6">
                <div
                    id="litros-display"
                    class="text-7xl font-black text-green-400 transition-colors duration-500"
                >
                    0.0
                </div>
                <div
                    class="text-gray-500 uppercase text-xs font-bold tracking-widest mt-1"
                >
                    Litros no Tanque
                </div>
            </div>

            <div
                class="relative w-full h-10 bg-gray-900 rounded-2xl overflow-hidden mb-8 border-2 border-gray-700"
            >
                <div
                    id="fuel-bar"
                    class="h-full fuel-gradient transition-all duration-1000"
                    style="width: 0%"
                ></div>
                <div
                    class="absolute left-1/4 top-0 bottom-0 w-0.5 bg-white/20"
                ></div>
                <div
                    class="absolute left-1/2 top-0 bottom-0 w-0.5 bg-white/20"
                ></div>
                <div
                    class="absolute left-3/4 top-0 bottom-0 w-0.5 bg-white/10"
                ></div>
            </div>

            <div
                class="text-center mb-8 bg-black/30 p-4 rounded-2xl border border-gray-700/50 shadow-inner"
            >
                <div
                    class="text-gray-500 uppercase text-[10px] font-bold tracking-tighter mb-1"
                >
                    Último Odômetro Salvo
                </div>
                <div class="text-3xl font-mono text-blue-400 font-bold">
                    <span id="km-atual-texto">0</span>
                    <span class="text-base text-blue-700">KM</span>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <label
                        class="block text-gray-400 text-sm mb-3 text-center font-medium"
                        >Atualizar KM Atual:</label
                    >
                    <div class="flex items-center justify-between gap-3">
                        <button
                            onclick="ajustarKm(-1)"
                            class="bg-gray-700 active:bg-gray-600 w-16 h-16 rounded-2xl text-3xl font-bold shadow-lg border-b-4 border-gray-900 flex items-center justify-center"
                        >
                            －
                        </button>

                        <input
                            type="number"
                            id="km-input"
                            class="w-full bg-gray-900 border border-gray-600 rounded-2xl p-4 text-2xl text-center focus:border-blue-500 outline-none font-mono shadow-inner"
                            placeholder="000000"
                        />

                        <button
                            onclick="ajustarKm(1)"
                            class="bg-gray-700 active:bg-gray-600 w-16 h-16 rounded-2xl text-3xl font-bold shadow-lg border-b-4 border-gray-900 flex items-center justify-center"
                        >
                            ＋
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-gray-400 text-xs mb-2 font-bold uppercase"
                            >Abasteceu (L)?</label
                        >
                        <input
                            type="number"
                            id="litros-add"
                            class="w-full bg-gray-900 border border-gray-600 rounded-2xl p-4 text-xl focus:border-green-500 outline-none shadow-inner"
                            placeholder="0"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-gray-400 text-xs mb-2 font-bold uppercase"
                            >Tipo</label
                        >
                        <select
                            id="tipo-combustivel"
                            class="w-full bg-gray-900 border border-gray-600 rounded-2xl p-4 text-lg focus:border-green-500 outline-none appearance-none shadow-inner"
                        >
                            <option value="etanol" selected>Etanol</option>
                            <option value="gasolina">Gasolina</option>
                        </select>
                    </div>
                </div>

                <button
                    onclick="atualizarDados()"
                    class="w-full bg-green-600 hover:bg-green-500 active:scale-[0.98] transition-all text-white font-black py-5 rounded-[1.5rem] text-xl shadow-xl border-b-8 border-green-800 uppercase tracking-widest mt-4"
                >
                    Salvar Alterações
                </button>
            </div>
        </main>

        <footer
            class="mt-8 text-gray-600 text-[10px] uppercase tracking-widest"
        >
            Capacidade: 54L | Sedã 1.8 | Dev: Devi AI
        </footer>

        <script>
            let kmSalvaNoBanco = 0; // Variável global para controle da trava

            function ajustarKm(valor) {
                const input = document.getElementById("km-input");
                let valorInput = parseInt(input.value) || 0;

                // Lógica da trava: só permite diminuir se o valor no input for MAIOR que o que está salvo
                if (valor < 0 && valorInput <= kmSalvaNoBanco) {
                    console.log(
                        "Ação bloqueada: odômetro não pode ser menor que o registro atual.",
                    );
                    return;
                }

                input.value = valorInput + valor;
            }

            async function carregarStatus() {
                try {
                    const res = await fetch("/status");
                    const data = await res.json();
                    kmSalvaNoBanco = data.km; // Armazena a referência para a trava
                    atualizarTela(data.litros, data.km);
                } catch (e) {
                    console.error("Erro ao carregar dados:", e);
                }
            }

            function atualizarTela(litros, km) {
                const porcentagem = (litros / 54) * 100;
                document.getElementById("litros-display").innerText =
                    litros.toFixed(1);
                document.getElementById("fuel-bar").style.width =
                    `${Math.min(100, porcentagem)}%`;

                document.getElementById("km-atual-texto").innerText =
                    km.toLocaleString("pt-BR");
                document.getElementById("km-input").value = km;

                const display = document.getElementById("litros-display");
                if (litros < 6.75) {
                    display.classList.add("text-red-500");
                    display.classList.remove("text-green-400");
                } else {
                    display.classList.add("text-green-400");
                    display.classList.remove("text-red-500");
                }
            }

            async function atualizarDados() {
                const novaKm = parseFloat(
                    document.getElementById("km-input").value,
                );
                const novosLitros =
                    parseFloat(document.getElementById("litros-add").value) ||
                    0;
                const tipoCombustivel =
                    document.getElementById("tipo-combustivel").value;

                // Prevenção extra caso o usuário digite manualmente um valor menor que o atual
                if (novaKm < kmSalvaNoBanco) {
                    alert(
                        "O novo valor de KM não pode ser menor que o valor registrado (" +
                            kmSalvaNoBanco +
                            " km).",
                    );
                    return;
                }

                try {
                    const res = await fetch("/update", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            novaKm,
                            novosLitros,
                            tipoCombustivel,
                        }),
                    });

                    const data = await res.json();
                    kmSalvaNoBanco = data.novaKm; // Atualiza a trava com o novo valor salvo
                    atualizarTela(data.litrosAtuais, data.novaKm);
                    document.getElementById("litros-add").value = "";

                    const btn = event.target;
                    const originalText = btn.innerText;
                    btn.innerText = "SALVO!";
                    btn.classList.replace("bg-green-600", "bg-blue-600");
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.classList.replace("bg-blue-600", "bg-green-600");
                    }, 2000);
                } catch (e) {
                    alert("Erro ao salvar dados.");
                }
            }

            carregarStatus();
        </script>
    </body>
</html>
